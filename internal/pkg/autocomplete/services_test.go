package autocomplete_test

import (
	"testing"

	"github.com/SierraSoftworks/git-tool/internal/pkg/autocomplete"
	"github.com/SierraSoftworks/git-tool/internal/pkg/config"
	"github.com/SierraSoftworks/git-tool/internal/pkg/di"
	"github.com/SierraSoftworks/git-tool/internal/pkg/mocks"
	"github.com/stretchr/testify/assert"
)

func TestServices(t *testing.T) {
	//Setup
	out := &mocks.Output{}
	di.SetOutput(out)
	di.SetConfig(config.Default())

	t.Run("With no filter", func(t *testing.T) {
		out.Reset()
		c := autocomplete.NewCompleter("")

		c.Services()
		assert.Contains(t, out.GetOperations(), "github.com\n", "it should print out the default services")
		assert.Contains(t, out.GetOperations(), "dev.azure.com\n", "it should print out the default services")
	})

	t.Run("With a matching filter", func(t *testing.T) {
		out.Reset()
		c := autocomplete.NewCompleter("github")

		c.Services()
		assert.Contains(t, out.GetOperations(), "github.com\n", "it should print out the default services")
		assert.NotContains(t, out.GetOperations(), "dev.azure.com\n", "it should print out the default services")
	})

	t.Run("With a filter that doesn't match", func(t *testing.T) {
		out.Reset()
		c := autocomplete.NewCompleter("nomatch")

		c.Services()
		assert.Empty(t, out.GetOperations(), "it should not print out any services")
	})
}

func TestServicePrefixes(t *testing.T) {
	//Setup
	out := &mocks.Output{}
	di.SetOutput(out)
	di.SetConfig(config.Default())

	t.Run("With no filter", func(t *testing.T) {
		out.Reset()
		c := autocomplete.NewCompleter("")

		c.ServicePrefixes()

		assert.Contains(t, out.GetOperations(), "github.com/\n", "it should print out the default services")
	})

	t.Run("With a matching filter", func(t *testing.T) {
		out.Reset()
		c := autocomplete.NewCompleter("github")

		c.ServicePrefixes()
		assert.Contains(t, out.GetOperations(), "github.com/\n", "it should print out the default services")
	})

	t.Run("With a filter that doesn't match", func(t *testing.T) {
		out.Reset()
		c := autocomplete.NewCompleter("nomatch")

		c.ServicePrefixes()
		assert.Empty(t, out.GetOperations(), "it should not print out any services")
	})
}
